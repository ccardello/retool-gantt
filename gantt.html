<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Retool Resource Gantt</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #fff;
      padding: 20px;
      overflow-x: auto;
    }
    
    .gantt-grid {
      display: grid;
      grid-template-columns: 150px repeat(12, 90px);
      gap: 0;
      border: 1px solid #e5e7eb;
      min-width: 1200px;
    }
    
    .gantt-cell {
      border: 1px solid #e5e7eb;
      padding: 8px;
      font-size: 11px;
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    .header-cell {
      background: #00205B;
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .person-cell {
      background: #f9fafb;
      font-weight: 500;
      justify-content: flex-start;
      padding-left: 12px;
    }
    
    .week-cell {
      background: #fafafa;
      cursor: pointer;
    }
    
    .week-cell:hover {
      background: #f0f4f8;
    }
    
    .allocation-bar {
      position: absolute;
      top: 4px;
      bottom: 4px;
      left: 4px;
      right: 4px;
      background: #3b82f6;
      color: white;
      font-weight: 500;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      cursor: pointer;
      z-index: 5;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      padding: 0 8px;
    }
    
    .allocation-bar:hover {
      opacity: 0.9;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      z-index: 20;
    }
    
    .allocation-span {
      grid-column: span var(--span);
    }
  </style>
</head>
<body>
  <div class="gantt-grid" id="ganttGrid"></div>
  
  <script>
    let ganttData = null;

    function getData() {
      try {
        const hash = window.location.hash.substring(1);
        if (hash) {
          return JSON.parse(decodeURIComponent(hash));
        }
      } catch (e) {
        console.error('Error parsing data:', e);
      }
      return null;
    }

    function render() {
      ganttData = getData();
      const grid = document.getElementById('ganttGrid');
      grid.innerHTML = '';
      
      if (!ganttData || !ganttData.people || ganttData.people.length === 0) {
        grid.innerHTML = '<div style="grid-column: 1 / -1; padding: 40px; text-align: center; color: #999;">No people found. Select a team.</div>';
        return;
      }

      // Header row
      const headerPerson = document.createElement('div');
      headerPerson.className = 'gantt-cell header-cell';
      headerPerson.textContent = 'Person';
      grid.appendChild(headerPerson);

      for (let i = 1; i <= 12; i++) {
        const headerWeek = document.createElement('div');
        headerWeek.className = 'gantt-cell header-cell';
        headerWeek.textContent = `W${i}`;
        grid.appendChild(headerWeek);
      }

      // Data rows
      ganttData.people.forEach(person => {
        // Person name cell
        const personCell = document.createElement('div');
        personCell.className = 'gantt-cell person-cell';
        personCell.textContent = person.name;
        grid.appendChild(personCell);

        // Week cells
        for (let week = 1; week <= 12; week++) {
          const weekCell = document.createElement('div');
          weekCell.className = 'gantt-cell week-cell';
          weekCell.dataset.personId = person.id;
          weekCell.dataset.week = week;
          
          // Check if any allocation STARTS here
          const startingAlloc = (ganttData.tasks || []).find(t => 
            t.person_id === person.id && t.start_week === week
          );

          if (startingAlloc) {
            // Add allocation bar
            const bar = document.createElement('div');
            bar.className = 'allocation-bar';
            bar.textContent = startingAlloc.text;
            bar.style.background = startingAlloc.project_color || '#3b82f6';
            bar.dataset.allocId = startingAlloc.id;
            
            // Make the cell span multiple columns
            weekCell.style.gridColumn = `span ${startingAlloc.duration}`;
            
            bar.addEventListener('click', function(e) {
              e.stopPropagation();
              window.parent.postMessage({
                type: 'ALLOCATION_CLICK',
                allocationId: startingAlloc.id,
                projectName: startingAlloc.text
              }, '*');
            });
            
            weekCell.appendChild(bar);
            grid.appendChild(weekCell);
            
            // Skip the next (duration - 1) weeks since we spanned them
            week += startingAlloc.duration - 1;
          } else {
            // Check if this week is covered by an earlier allocation
            const coveringAlloc = (ganttData.tasks || []).find(t => 
              t.person_id === person.id && 
              t.start_week < week && 
              (t.start_week + t.duration) > week
            );
            
            if (!coveringAlloc) {
              // Empty cell
              weekCell.addEventListener('click', function() {
                window.parent.postMessage({
                  type: 'WEEK_CELL_CLICK',
                  personId: person.id,
                  personName: person.name,
                  week: week
                }, '*');
              });
              
              grid.appendChild(weekCell);
            }
          }
        }
      });
    }

    window.addEventListener('hashchange', render);
    window.addEventListener('load', render);
    window.parent.postMessage({ type: 'GANTT_READY' }, '*');
  </script>
</body>
</html>
