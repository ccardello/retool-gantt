<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Retool Resource Gantt</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #fff;
      overflow-x: auto;
    }
    .gantt-container {
      position: relative;
      padding: 20px;
      min-width: 1200px;
    }
    .gantt-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    .gantt-table th,
    .gantt-table td {
      border: 1px solid #e5e7eb;
      padding: 8px;
      text-align: center;
      font-size: 11px;
      vertical-align: middle;
      height: 40px;
    }
    .gantt-table th {
      background: #00205B;
      color: white;
      font-weight: 600;
      white-space: nowrap;
    }
    .gantt-table th.person-col {
      width: 150px;
      text-align: left;
    }
    .gantt-table th.week-col {
      width: 90px;
    }
    .gantt-table td.person {
      background: #f9fafb;
      font-weight: 500;
      text-align: left;
    }
    .gantt-table td.week {
      background: #fafafa;
      cursor: pointer;
      position: relative;
    }
    .gantt-table td.week:hover {
      background: #f0f4f8;
    }
    
    /* Allocation bars overlay */
    .allocations-layer {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 10;
    }
    .allocation-bar {
      position: absolute;
      height: 32px;
      color: white;
      font-weight: 500;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: move;
      border-radius: 4px;
      padding: 0 8px;
      pointer-events: auto;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .allocation-bar:hover {
      opacity: 0.9;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      z-index: 20;
    }
  </style>
</head>
<body>
  <div class="gantt-container">
    <div class="allocations-layer" id="allocationsLayer"></div>
    <table class="gantt-table" id="ganttTable">
      <thead>
        <tr id="headerRow">
          <th class="person-col">Person</th>
        </tr>
      </thead>
      <tbody id="ganttBody"></tbody>
    </table>
  </div>
  
  <script>
    let ganttData = null;
    const WEEK_WIDTH = 90;  // Must match CSS
    const PERSON_COL_WIDTH = 150;
    const ROW_HEIGHT = 40;
    const HEADER_HEIGHT = 40;

    function getData() {
      try {
        const hash = window.location.hash.substring(1);
        if (hash) {
          return JSON.parse(decodeURIComponent(hash));
        }
      } catch (e) {
        console.error('Error parsing data:', e);
      }
      return null;
    }

    function renderTable() {
      ganttData = getData();
      
      if (!ganttData || !ganttData.people || ganttData.people.length === 0) {
        document.getElementById('ganttBody').innerHTML = 
          '<tr><td colspan="13" style="text-align:center;padding:40px;color:#999;">No people found. Select a team.</td></tr>';
        return;
      }

      // Render header
      const headerRow = document.getElementById('headerRow');
      headerRow.innerHTML = '<th class="person-col">Person</th>';
      for (let i = 1; i <= 12; i++) {
        const th = document.createElement('th');
        th.className = 'week-col';
        th.textContent = `W${i}`;
        headerRow.appendChild(th);
      }

      // Render body
      const tbody = document.getElementById('ganttBody');
      tbody.innerHTML = '';

      ganttData.people.forEach((person, personIndex) => {
        const row = document.createElement('tr');
        row.dataset.personId = person.id;
        row.dataset.rowIndex = personIndex;
        
        const nameCell = document.createElement('td');
        nameCell.className = 'person';
        nameCell.textContent = person.name;
        row.appendChild(nameCell);

        for (let week = 1; week <= 12; week++) {
          const cell = document.createElement('td');
          cell.className = 'week';
          cell.dataset.personId = person.id;
          cell.dataset.week = week;
          cell.dataset.rowIndex = personIndex;
          cell.dataset.colIndex = week - 1;
          
          cell.addEventListener('click', function() {
            window.parent.postMessage({
              type: 'WEEK_CELL_CLICK',
              personId: person.id,
              personName: person.name,
              week: week
            }, '*');
          });
          
          row.appendChild(cell);
        }

        tbody.appendChild(row);
      });
    }

    function renderAllocations() {
      if (!ganttData) return;
      
      const layer = document.getElementById('allocationsLayer');
      layer.innerHTML = '';

      (ganttData.tasks || []).forEach(task => {
        // Find the row index for this person
        const rowIndex = ganttData.people.findIndex(p => p.id === task.person_id);
        if (rowIndex === -1) return;

        // Calculate position
        const left = PERSON_COL_WIDTH + ((task.start_week - 1) * WEEK_WIDTH);
        const top = HEADER_HEIGHT + (rowIndex * ROW_HEIGHT) + 4;
        const width = task.duration * WEEK_WIDTH - 8;

        const bar = document.createElement('div');
        bar.className = 'allocation-bar';
        bar.textContent = task.text;
        bar.style.left = left + 'px';
        bar.style.top = top + 'px';
        bar.style.width = width + 'px';
        bar.style.background = task.project_color || '#3b82f6';
        bar.dataset.allocId = task.id;

        bar.addEventListener('click', function(e) {
          e.stopPropagation();
          window.parent.postMessage({
            type: 'ALLOCATION_CLICK',
            allocationId: task.id,
            projectName: task.text
          }, '*');
        });

        layer.appendChild(bar);
      });
    }

    function render() {
      renderTable();
      renderAllocations();
    }

    window.addEventListener('hashchange', render);
    window.addEventListener('load', render);
    window.parent.postMessage({ type: 'GANTT_READY' }, '*');
  </script>
</body>
</html>
