<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Retool Resource Gantt</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #fff;
      overflow-x: auto;
    }
    .gantt-wrapper {
      min-width: 1200px;
      padding: 20px;
    }
    .gantt-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    .gantt-table th,
    .gantt-table td {
      border: 1px solid #e5e7eb;
      padding: 8px;
      text-align: center;
      font-size: 11px;
      vertical-align: middle;
    }
    .gantt-table th {
      background: #00205B;
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
    }
    .gantt-table th.person-col {
      width: 150px;
      text-align: left;
    }
    .gantt-table th.week-col {
      width: 80px;
    }
    .gantt-table td.person {
      background: #f9fafb;
      font-weight: 500;
      text-align: left;
    }
    .gantt-table td.week {
      background: #fafafa;
      cursor: pointer;
      position: relative;
      height: 35px;
      padding: 2px;
    }
    .gantt-table td.week:hover {
      background: #f0f4f8;
    }
    .allocation-bar {
      position: absolute;
      top: 2px;
      bottom: 2px;
      left: 0;
      color: white;
      font-weight: 500;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: move;
      border-radius: 3px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      padding: 0 4px;
    }
    .allocation-bar:hover {
      opacity: 0.9;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .resize-handle {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 8px;
      cursor: ew-resize;
      background: rgba(0,0,0,0.1);
      opacity: 0;
    }
    .resize-handle:hover {
      opacity: 1;
    }
    .resize-handle.left {
      left: 0;
    }
    .resize-handle.right {
      right: 0;
    }
  </style>
</head>
<body>
  <div class="gantt-wrapper">
    <table class="gantt-table" id="ganttTable">
      <thead>
        <tr>
          <th class="person-col">Person</th>
        </tr>
      </thead>
      <tbody id="ganttBody">
      </tbody>
    </table>
  </div>
  
  <script>
    let ganttData = null;

    function getData() {
      try {
        const hash = window.location.hash.substring(1);
        if (hash) {
          return JSON.parse(decodeURIComponent(hash));
        }
      } catch (e) {
        console.error('Error parsing data:', e);
      }
      return null;
    }

    function renderGantt() {
      ganttData = getData();
      
      if (!ganttData || !ganttData.people || ganttData.people.length === 0) {
        document.getElementById('ganttBody').innerHTML = 
          '<tr><td colspan="13" style="text-align:center;padding:40px;color:#999;">No data available. Select a team in Retool.</td></tr>';
        return;
      }

      // Render header with 12 weeks
      const headerRow = document.querySelector('thead tr');
      headerRow.innerHTML = '<th class="person-col">Person</th>';
      
      // Generate week labels (simple: 1, 2, 3... 12)
      for (let i = 1; i <= 12; i++) {
        const th = document.createElement('th');
        th.className = 'week-col';
        th.textContent = `W${i}`;
        headerRow.appendChild(th);
      }

      // Render body rows
      const tbody = document.getElementById('ganttBody');
      tbody.innerHTML = '';

      ganttData.people.forEach(person => {
        const row = document.createElement('tr');
        
        // Person name cell
        const nameCell = document.createElement('td');
        nameCell.className = 'person';
        nameCell.textContent = person.name;
        row.appendChild(nameCell);

        // Week cells
        for (let week = 1; week <= 12; week++) {
          const cell = document.createElement('td');
          cell.className = 'week';
          cell.dataset.personId = person.id;
          cell.dataset.week = week;
          
          // Find allocations for this person/week
          const allocations = (ganttData.tasks || []).filter(t => 
            t.person_id === person.id &&
            t.start_week <= week &&
            (t.start_week + t.duration) > week
          );

          // Render allocation bars
          allocations.forEach(alloc => {
            if (alloc.start_week === week) {
              // This is the starting cell for this allocation
              const bar = document.createElement('div');
              bar.className = 'allocation-bar';
              bar.textContent = alloc.text;
              bar.style.background = alloc.project_color || '#3b82f6';
              bar.style.width = `${alloc.duration * 100}%`;
              bar.dataset.allocId = alloc.id;
              
              cell.appendChild(bar);
            }
          });
          
          row.appendChild(cell);
        }

        tbody.appendChild(row);
      });
    }

    window.addEventListener('hashchange', renderGantt);
    window.addEventListener('load', renderGantt);
    window.parent.postMessage({ type: 'GANTT_READY' }, '*');
  </script>
</body>
</html>
