<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Retool Resource Gantt</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #fff;
      padding: 20px;
      overflow-x: auto;
    }
    
    .gantt-wrapper {
      min-width: 1200px;
    }
    
    .person-section {
      margin-bottom: 0;
    }
    
    .person-header {
      display: grid;
      grid-template-columns: 150px repeat(12, 90px);
      border: 1px solid #e5e7eb;
      border-bottom: none;
    }
    
    .person-name-cell {
      background: #f9fafb;
      font-weight: 600;
      padding: 12px;
      border-right: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
    }
    
    .person-rows {
      display: grid;
      grid-template-columns: 150px repeat(12, 90px);
      border: 1px solid #e5e7eb;
    }
    
    .allocation-row {
      display: contents;
    }
    
    .row-label {
      background: #fafafa;
      padding: 8px 12px;
      border-right: 1px solid #e5e7eb;
      border-top: 1px solid #e5e7eb;
      font-size: 10px;
      color: #6b7280;
      display: flex;
      align-items: center;
    }
    
    .week-cell {
      background: #fafafa;
      border-right: 1px solid #e5e7eb;
      border-top: 1px solid #e5e7eb;
      min-height: 36px;
      position: relative;
      cursor: pointer;
    }
    
    .week-cell:hover {
      background: #f0f4f8;
    }
    
    .allocation-bar {
      position: absolute;
      top: 4px;
      bottom: 4px;
      left: 4px;
      right: 4px;
      background: #3b82f6;
      color: white;
      font-weight: 500;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      cursor: pointer;
      z-index: 5;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      padding: 0 8px;
    }
    
    .allocation-bar:hover {
      opacity: 0.9;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      z-index: 20;
    }
    
    .allocation-span {
      grid-column: span var(--span);
    }
    
    .header-grid {
      display: grid;
      grid-template-columns: 150px repeat(12, 90px);
      border: 1px solid #e5e7eb;
      position: sticky;
      top: 0;
      z-index: 100;
      background: white;
    }
    
    .header-cell {
      background: #00205B;
      color: white;
      font-weight: 600;
      padding: 12px 8px;
      text-align: center;
      font-size: 11px;
      border-right: 1px solid #003082;
    }
    
    .header-cell:first-child {
      text-align: left;
      padding-left: 12px;
    }
  </style>
</head>
<body>
  <div class="gantt-wrapper" id="ganttWrapper"></div>
  
  <script>
    let ganttData = null;

    function getData() {
      try {
        const hash = window.location.hash.substring(1);
        if (hash) {
          return JSON.parse(decodeURIComponent(hash));
        }
      } catch (e) {
        console.error('Error parsing data:', e);
      }
      return null;
    }

    function findOverlappingAllocations(allocations) {
      // Group allocations into non-overlapping rows
      const rows = [];
      
      allocations.forEach(alloc => {
        let placed = false;
        
        // Try to place in existing row
        for (let row of rows) {
          const overlaps = row.some(existing => 
            !(alloc.start_week >= existing.start_week + existing.duration || 
              alloc.start_week + alloc.duration <= existing.start_week)
          );
          
          if (!overlaps) {
            row.push(alloc);
            placed = true;
            break;
          }
        }
        
        // Create new row if needed
        if (!placed) {
          rows.push([alloc]);
        }
      });
      
      return rows;
    }

    function render() {
      ganttData = getData();
      const wrapper = document.getElementById('ganttWrapper');
      wrapper.innerHTML = '';
      
      if (!ganttData || !ganttData.people || ganttData.people.length === 0) {
        wrapper.innerHTML = '<div style="padding: 40px; text-align: center; color: #999;">No people found. Select a team.</div>';
        return;
      }

      // Header
      const header = document.createElement('div');
      header.className = 'header-grid';
      header.innerHTML = '<div class="header-cell">Person</div>';
      for (let i = 1; i <= 12; i++) {
        header.innerHTML += `<div class="header-cell">W${i}</div>`;
      }
      wrapper.appendChild(header);

      // People sections
      ganttData.people.forEach(person => {
        const personAllocs = (ganttData.tasks || []).filter(t => t.person_id === person.id);
        const allocRows = findOverlappingAllocations(personAllocs);
        
        // Person section
        const section = document.createElement('div');
        section.className = 'person-section';
        
        // Person header
        const personHeader = document.createElement('div');
        personHeader.className = 'person-header';
        personHeader.innerHTML = `<div class="person-name-cell">${person.name}</div>`;
        for (let i = 0; i < 12; i++) {
          personHeader.innerHTML += '<div></div>';
        }
        section.appendChild(personHeader);
        
        // Allocation rows
        const personRows = document.createElement('div');
        personRows.className = 'person-rows';
        
        if (allocRows.length === 0) {
          // Empty row
          personRows.innerHTML = '<div class="row-label"></div>';
          for (let week = 1; week <= 12; week++) {
            const cell = document.createElement('div');
            cell.className = 'week-cell';
            cell.addEventListener('click', () => {
              window.parent.postMessage({
                type: 'WEEK_CELL_CLICK',
                personId: person.id,
                personName: person.name,
                week: week
              }, '*');
            });
            personRows.appendChild(cell);
          }
        } else {
          // Render each allocation row
          allocRows.forEach((row, rowIndex) => {
            const rowLabel = document.createElement('div');
            rowLabel.className = 'row-label';
            rowLabel.textContent = rowIndex === 0 ? '' : `Row ${rowIndex + 1}`;
            personRows.appendChild(rowLabel);
            
            for (let week = 1; week <= 12; week++) {
              const alloc = row.find(a => a.start_week === week);
              
              if (alloc) {
                const cell = document.createElement('div');
                cell.className = 'week-cell';
                cell.style.gridColumn = `span ${alloc.duration}`;
                
                const bar = document.createElement('div');
                bar.className = 'allocation-bar';
                bar.textContent = alloc.text;
                bar.style.background = alloc.project_color || '#3b82f6';
                bar.title = `${alloc.text} - Click to edit`;
                
                bar.addEventListener('click', (e) => {
                  e.stopPropagation();
                  window.parent.postMessage({
                    type: 'ALLOCATION_CLICK',
                    allocationId: alloc.id,
                    projectName: alloc.text
                  }, '*');
                });
                
                cell.appendChild(bar);
                personRows.appendChild(cell);
                week += alloc.duration - 1;
              } else {
                // Check if covered by earlier allocation
                const covered = row.some(a => 
                  a.start_week < week && a.start_week + a.duration > week
                );
                
                if (!covered) {
                  const cell = document.createElement('div');
                  cell.className = 'week-cell';
                  cell.addEventListener('click', () => {
                    window.parent.postMessage({
                      type: 'WEEK_CELL_CLICK',
                      personId: person.id,
                      personName: person.name,
                      week: week
                    }, '*');
                  });
                  personRows.appendChild(cell);
                }
              }
            }
          });
        }
        
        section.appendChild(personRows);
        wrapper.appendChild(section);
      });
    }

    window.addEventListener('hashchange', render);
    window.addEventListener('load', render);
    window.parent.postMessage({ type: 'GANTT_READY' }, '*');
  </script>
</body>
</html>
