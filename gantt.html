<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Retool Resource Gantt</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #fff;
      padding: 20px;
      overflow-x: auto;
    }
    
    .gantt-table {
      display: table;
      border-collapse: collapse;
      min-width: 1200px;
      width: 100%;
      border: 1px solid #e5e7eb;
    }
    
    .gantt-header {
      display: table-row;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-cell {
      display: table-cell;
      background: #00205B;
      color: white;
      font-weight: 600;
      padding: 12px 8px;
      text-align: center;
      font-size: 11px;
      border: 1px solid #003082;
      position: sticky;
      top: 0;
    }
    
    .header-person {
      width: 150px;
      text-align: left;
      padding-left: 12px;
    }
    
    .header-week {
      width: 90px;
    }
    
    .person-group {
      display: table-row-group;
    }
    
    .allocation-row {
      display: table-row;
    }
    
    .person-cell {
      display: table-cell;
      background: #f9fafb;
      font-weight: 600;
      padding: 12px;
      border: 1px solid #e5e7eb;
      vertical-align: middle;
      width: 150px;
    }
    
    .week-cell {
      display: table-cell;
      background: #fafafa;
      border: 1px solid #e5e7eb;
      min-height: 40px;
      height: 40px;
      position: relative;
      cursor: pointer;
      width: 90px;
    }
    
    .week-cell:hover {
      background: #f0f4f8;
    }
    
    .allocation-bar {
      position: absolute;
      top: 4px;
      bottom: 4px;
      left: 4px;
      right: 4px;
      background: #3b82f6;
      color: white;
      font-weight: 500;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      cursor: pointer;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      padding: 0 8px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .allocation-bar:hover {
      opacity: 0.9;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      z-index: 20;
    }
  </style>
</head>
<body>
  <div class="gantt-table" id="ganttTable"></div>
  
  <script>
    let ganttData = null;

    function getData() {
      try {
        const hash = window.location.hash.substring(1);
        if (hash) {
          return JSON.parse(decodeURIComponent(hash));
        }
      } catch (e) {
        console.error('Error parsing data:', e);
      }
      return null;
    }

    function findOverlappingAllocations(allocations) {
      // Group allocations into non-overlapping rows
      const rows = [];
      
      allocations.forEach(alloc => {
        let placed = false;
        
        // Try to place in existing row
        for (let row of rows) {
          const overlaps = row.some(existing => 
            !(alloc.start_week >= existing.start_week + existing.duration || 
              alloc.start_week + alloc.duration <= existing.start_week)
          );
          
          if (!overlaps) {
            row.push(alloc);
            placed = true;
            break;
          }
        }
        
        // Create new row if needed
        if (!placed) {
          rows.push([alloc]);
        }
      });
      
      return rows;
    }

    function render() {
      ganttData = getData();
      const table = document.getElementById('ganttTable');
      table.innerHTML = '';
      
      if (!ganttData || !ganttData.people || ganttData.people.length === 0) {
        table.innerHTML = '<div style="padding: 40px; text-align: center; color: #999;">No people found. Select a team.</div>';
        return;
      }

      // Header row
      const header = document.createElement('div');
      header.className = 'gantt-header';
      
      const headerPerson = document.createElement('div');
      headerPerson.className = 'header-cell header-person';
      headerPerson.textContent = 'Person';
      header.appendChild(headerPerson);
      
      for (let i = 1; i <= 12; i++) {
        const headerWeek = document.createElement('div');
        headerWeek.className = 'header-cell header-week';
        headerWeek.textContent = `W${i}`;
        header.appendChild(headerWeek);
      }
      table.appendChild(header);

      // People rows
      ganttData.people.forEach(person => {
        const personAllocs = (ganttData.tasks || []).filter(t => t.person_id === person.id);
        const allocRows = findOverlappingAllocations(personAllocs);
        
        // If no allocations, show one empty row
        const numRows = allocRows.length || 1;
        
        const group = document.createElement('div');
        group.className = 'person-group';
        
        allocRows.forEach((row, rowIndex) => {
          const tr = document.createElement('div');
          tr.className = 'allocation-row';
          
          // Person cell (only on first row, spans all rows)
          if (rowIndex === 0) {
            const personCell = document.createElement('div');
            personCell.className = 'person-cell';
            personCell.textContent = person.name;
            personCell.style.gridRow = `span ${numRows}`;
            personCell.rowSpan = numRows;
            tr.appendChild(personCell);
          }
          
          // Week cells
          for (let week = 1; week <= 12; week++) {
            const alloc = row.find(a => a.start_week === week);
            
            if (alloc) {
              const cell = document.createElement('div');
              cell.className = 'week-cell';
              cell.colSpan = alloc.duration;
              cell.style.width = `${alloc.duration * 90}px`;
              
              const bar = document.createElement('div');
              bar.className = 'allocation-bar';
              bar.textContent = alloc.text;
              bar.style.background = alloc.project_color || '#3b82f6';
              bar.title = `${alloc.text} - Click to edit`;
              
              bar.addEventListener('click', (e) => {
                e.stopPropagation();
                window.parent.postMessage({
                  type: 'ALLOCATION_CLICK',
                  allocationId: alloc.id,
                  projectName: alloc.text
                }, '*');
              });
              
              cell.appendChild(bar);
              tr.appendChild(cell);
              week += alloc.duration - 1;
            } else {
              // Check if covered by earlier allocation
              const covered = row.some(a => 
                a.start_week < week && a.start_week + a.duration > week
              );
              
              if (!covered) {
                const cell = document.createElement('div');
                cell.className = 'week-cell';
                cell.addEventListener('click', () => {
                  window.parent.postMessage({
                    type: 'WEEK_CELL_CLICK',
                    personId: person.id,
                    personName: person.name,
                    week: week
                  }, '*');
                });
                tr.appendChild(cell);
              }
            }
          }
          
          group.appendChild(tr);
        });
        
        // Handle empty person (no allocations)
        if (allocRows.length === 0) {
          const tr = document.createElement('div');
          tr.className = 'allocation-row';
          
          const personCell = document.createElement('div');
          personCell.className = 'person-cell';
          personCell.textContent = person.name;
          tr.appendChild(personCell);
          
          for (let week = 1; week <= 12; week++) {
            const cell = document.createElement('div');
            cell.className = 'week-cell';
            cell.addEventListener('click', () => {
              window.parent.postMessage({
                type: 'WEEK_CELL_CLICK',
                personId: person.id,
                personName: person.name,
                week: week
              }, '*');
            });
            tr.appendChild(cell);
          }
          
          group.appendChild(tr);
        }
        
        table.appendChild(group);
      });
    }

    window.addEventListener('hashchange', render);
    window.addEventListener('load', render);
    window.parent.postMessage({ type: 'GANTT_READY' }, '*');
  </script>
</body>
</html>
