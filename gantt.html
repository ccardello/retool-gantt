<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Retool Resource Gantt</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #fff;
      padding: 20px;
      overflow-x: auto;
    }
    
    .gantt-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1200px;
      border: 1px solid #e5e7eb;
    }
    
    .gantt-table th {
      background: #00205B;
      color: white;
      font-weight: 600;
      padding: 12px 8px;
      text-align: center;
      font-size: 11px;
      border: 1px solid #003082;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .gantt-table th:first-child {
      width: 150px;
      text-align: left;
      padding-left: 12px;
    }
    
    .gantt-table th:not(:first-child) {
      width: 90px;
    }
    
    .gantt-table td {
      border: 1px solid #e5e7eb;
      padding: 0;
      vertical-align: middle;
    }
    
    .person-cell {
      background: #f9fafb;
      font-weight: 600;
      padding: 12px;
      text-align: left;
      width: 150px;
    }
    
    .weeks-cell {
      background: #fafafa;
      position: relative;
      width: 1080px;
    }
    
    .week-grid {
      display: grid;
      grid-template-columns: repeat(12, 90px);
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }
    
    .week-slot {
      border-right: 1px solid #e5e7eb;
      cursor: pointer;
      min-height: 40px;
    }
    
    .week-slot:hover {
      background: #f0f4f8;
    }
    
    .allocations-layer {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
    }
    
    .allocation-track {
      position: absolute;
      left: 0;
      right: 0;
      height: 36px;
      pointer-events: none;
    }
    
    .allocation-bar {
      position: absolute;
      top: 2px;
      bottom: 2px;
      background: #3b82f6;
      color: white;
      font-weight: 500;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      cursor: pointer;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      padding: 0 8px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      pointer-events: auto;
    }
    
    .allocation-bar:hover {
      opacity: 0.9;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      z-index: 20;
    }
  </style>
</head>
<body>
  <table class="gantt-table" id="ganttTable">
    <thead id="ganttHeader"></thead>
    <tbody id="ganttBody"></tbody>
  </table>
  
  <script>
    let ganttData = null;
    const WEEK_WIDTH = 90;
    const TRACK_HEIGHT = 36;

    function getData() {
      try {
        const hash = window.location.hash.substring(1);
        if (hash) {
          return JSON.parse(decodeURIComponent(hash));
        }
      } catch (e) {
        console.error('Error parsing data:', e);
      }
      return null;
    }

    function generateWeekDates() {
      const dates = [];
      const today = new Date();
      const day = today.getDay();
      const diff = today.getDate() - day + (day === 0 ? -6 : 1);
      const monday = new Date(today.setDate(diff));
      monday.setHours(0, 0, 0, 0);
      
      for (let i = 0; i < 12; i++) {
        const weekDate = new Date(monday);
        weekDate.setDate(weekDate.getDate() + (i * 7));
        const month = weekDate.getMonth() + 1;
        const day = weekDate.getDate();
        dates.push(month + '/' + day);
      }
      return dates;
    }

    function renderHeader() {
      const header = document.getElementById('ganttHeader');
      const weekDates = generateWeekDates();
      
      let headerHTML = '<tr><th>Person</th>';
      for (let i = 0; i < 12; i++) {
        headerHTML += '<th>' + weekDates[i] + '</th>';
      }
      headerHTML += '</tr>';
      header.innerHTML = headerHTML;
    }

    function findOverlappingAllocations(allocations) {
      const tracks = [];
      
      allocations.forEach(function(alloc) {
        let placed = false;
        
        for (let track of tracks) {
          const overlaps = track.some(function(existing) {
            return !(alloc.start_week >= existing.start_week + existing.duration || 
              alloc.start_week + alloc.duration <= existing.start_week);
          });
          
          if (!overlaps) {
            track.push(alloc);
            placed = true;
            break;
          }
        }
        
        if (!placed) {
          tracks.push([alloc]);
        }
      });
      
      return tracks;
    }

    function render() {
      ganttData = getData();
      const tbody = document.getElementById('ganttBody');
      tbody.innerHTML = '';
      
      if (!ganttData || !ganttData.people || ganttData.people.length === 0) {
        tbody.innerHTML = '<tr><td colspan="13" style="padding: 40px; text-align: center; color: #999;">No people found. Select a team.</td></tr>';
        return;
      }

      renderHeader();

      ganttData.people.forEach(function(person) {
        const personAllocs = (ganttData.tasks || []).filter(function(t) {
          return t.person_id === person.id;
        });
        const tracks = findOverlappingAllocations(personAllocs);
        const numTracks = Math.max(tracks.length, 1);
        const rowHeight = numTracks * TRACK_HEIGHT;
        
        const tr = document.createElement('tr');
        tr.style.height = rowHeight + 'px';
        
        const personCell = document.createElement('td');
        personCell.className = 'person-cell';
        personCell.textContent = person.name;
        tr.appendChild(personCell);
        
        const weeksCell = document.createElement('td');
        weeksCell.className = 'weeks-cell';
        weeksCell.colSpan = 12;
        weeksCell.style.height = rowHeight + 'px';
        weeksCell.style.position = 'relative';
        
        const weekGrid = document.createElement('div');
        weekGrid.className = 'week-grid';
        for (let week = 1; week <= 12; week++) {
          const slot = document.createElement('div');
          slot.className = 'week-slot';
          (function(w, p) {
            slot.addEventListener('click', function() {
              window.parent.postMessage({
                type: 'WEEK_CELL_CLICK',
                personId: p.id,
                personName: p.name,
                week: w
              }, '*');
            });
          })(week, person);
          weekGrid.appendChild(slot);
        }
        weeksCell.appendChild(weekGrid);
        
        const allocLayer = document.createElement('div');
        allocLayer.className = 'allocations-layer';
        
        tracks.forEach(function(track, trackIndex) {
          const trackDiv = document.createElement('div');
          trackDiv.className = 'allocation-track';
          trackDiv.style.top = (trackIndex * TRACK_HEIGHT) + 'px';
          
          track.forEach(function(alloc) {
            const bar = document.createElement('div');
            bar.className = 'allocation-bar';
            bar.textContent = alloc.text;
            bar.style.background = alloc.project_color || '#3b82f6';
            bar.style.left = ((alloc.start_week - 1) * WEEK_WIDTH) + 'px';
            bar.style.width = (alloc.duration * WEEK_WIDTH - 4) + 'px';
            bar.title = alloc.text + ' - Click to edit';
            
            (function(a) {
              bar.addEventListener('click', function(e) {
                e.stopPropagation();
                window.parent.postMessage({
                  type: 'ALLOCATION_CLICK',
                  allocationId: a.id,
                  projectName: a.text
                }, '*');
              });
            })(alloc);
            
            trackDiv.appendChild(bar);
          });
          
          allocLayer.appendChild(trackDiv);
        });
        
        weeksCell.appendChild(allocLayer);
        tr.appendChild(weeksCell);
        tbody.appendChild(tr);
      });
    }

    window.addEventListener('hashchange', render);
    window.addEventListener('load', render);
    window.parent.postMessage({ type: 'GANTT_READY' }, '*');
  </script>
</body>
</html>
