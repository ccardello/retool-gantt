<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Retool Resource Gantt</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #fff;
      overflow-x: auto;
    }
    .gantt-container {
      position: relative;
      padding: 20px;
      min-width: 1200px;
    }
    .gantt-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    .gantt-table th,
    .gantt-table td {
      border: 1px solid #e5e7eb;
      padding: 8px;
      text-align: center;
      font-size: 11px;
      vertical-align: middle;
      height: 40px;
    }
    .gantt-table th {
      background: #00205B;
      color: white;
      font-weight: 600;
      white-space: nowrap;
    }
    .gantt-table th.person-col {
      width: 150px;
      text-align: left;
    }
    .gantt-table th.week-col {
      width: 90px;
    }
    .gantt-table td.person {
      background: #f9fafb;
      font-weight: 500;
      text-align: left;
    }
    .gantt-table td.week {
      background: #fafafa;
      cursor: pointer;
      position: relative;
    }
    .gantt-table td.week:hover {
      background: #f0f4f8;
    }
    
    .allocation-bar {
      position: absolute;
      height: 32px;
      color: white;
      font-weight: 500;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: 4px;
      padding: 0 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .allocation-bar:hover {
      opacity: 0.9;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      z-index: 100;
    }
  </style>
</head>
<body>
  <div class="gantt-container" id="ganttContainer">
    <table class="gantt-table" id="ganttTable">
      <thead>
        <tr id="headerRow">
          <th class="person-col">Person</th>
        </tr>
      </thead>
      <tbody id="ganttBody"></tbody>
    </table>
  </div>
  
  <script>
    let ganttData = null;

    function getData() {
      try {
        const hash = window.location.hash.substring(1);
        if (hash) {
          return JSON.parse(decodeURIComponent(hash));
        }
      } catch (e) {
        console.error('Error parsing data:', e);
      }
      return null;
    }

    function renderTable() {
      ganttData = getData();
      
      if (!ganttData || !ganttData.people || ganttData.people.length === 0) {
        document.getElementById('ganttBody').innerHTML = 
          '<tr><td colspan="13" style="text-align:center;padding:40px;color:#999;">No people found. Select a team.</td></tr>';
        return;
      }

      // Render header
      const headerRow = document.getElementById('headerRow');
      headerRow.innerHTML = '<th class="person-col">Person</th>';
      for (let i = 1; i <= 12; i++) {
        const th = document.createElement('th');
        th.className = 'week-col';
        th.textContent = `W${i}`;
        headerRow.appendChild(th);
      }

      // Render body
      const tbody = document.getElementById('ganttBody');
      tbody.innerHTML = '';

      ganttData.people.forEach((person, personIndex) => {
        const row = document.createElement('tr');
        row.dataset.personId = person.id;
        row.dataset.rowIndex = personIndex;
        
        const nameCell = document.createElement('td');
        nameCell.className = 'person';
        nameCell.textContent = person.name;
        row.appendChild(nameCell);

        for (let week = 1; week <= 12; week++) {
          const cell = document.createElement('td');
          cell.className = 'week';
          cell.dataset.personId = person.id;
          cell.dataset.week = week;
          cell.id = `cell-${person.id}-${week}`;
          
          cell.addEventListener('click', function() {
            window.parent.postMessage({
              type: 'WEEK_CELL_CLICK',
              personId: person.id,
              personName: person.name,
              week: week
            }, '*');
          });
          
          row.appendChild(cell);
        }

        tbody.appendChild(row);
      });
    }

    function renderAllocations() {
      if (!ganttData) return;
      
      const container = document.getElementById('ganttContainer');
      
      // Remove old allocation bars
      container.querySelectorAll('.allocation-bar').forEach(el => el.remove());

      (ganttData.tasks || []).forEach(task => {
        // Find the starting cell
        const startCell = document.getElementById(`cell-${task.person_id}-${task.start_week}`);
        if (!startCell) {
          console.warn('Could not find cell for allocation:', task);
          return;
        }

        // Get the cell's position and size
        const cellRect = startCell.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();
        
        // Calculate bar dimensions
        const cellWidth = cellRect.width;
        const barWidth = (cellWidth * task.duration) - 4;  // -4 for padding
        const barLeft = cellRect.left - containerRect.left + 2;
        const barTop = cellRect.top - containerRect.top + 4;

        const bar = document.createElement('div');
        bar.className = 'allocation-bar';
        bar.textContent = task.text;
        bar.style.position = 'absolute';
        bar.style.left = barLeft + 'px';
        bar.style.top = barTop + 'px';
        bar.style.width = barWidth + 'px';
        bar.style.background = task.project_color || '#3b82f6';
        bar.dataset.allocId = task.id;

        bar.addEventListener('click', function(e) {
          e.stopPropagation();
          window.parent.postMessage({
            type: 'ALLOCATION_CLICK',
            allocationId: task.id,
            projectName: task.text,
            personId: task.person_id,
            startWeek: task.start_week,
            duration: task.duration
          }, '*');
        });

        container.appendChild(bar);
      });
    }

    function render() {
      renderTable();
      // Delay allocation rendering to ensure DOM is ready
      setTimeout(renderAllocations, 100);
    }

    window.addEventListener('hashchange', render);
    window.addEventListener('load', render);
    window.addEventListener('resize', renderAllocations);  // Re-position on resize
    window.parent.postMessage({ type: 'GANTT_READY' }, '*');
  </script>
</body>
</html>
